# debian-specific tasks to setup and fetch the Elastic repo

- name: checking if ELK repo is already configured...
  stat: path={{ elk_repo_deb_path }}
  register: elk_repofile_result
# - debug: var=elk_repofile_result

# us this to add separate repo instead of apt_repository
# https://www.elastic.co/guide/en/elasticsearch/reference/current/deb.html
- name: add ELK repo
  copy:
    dest: "{{ elk_repo_deb_path }}"
    content: "deb https://artifacts.elastic.co/packages/6.x/apt stable main"
    owner: root
    group: root
    mode: 0644
  when: not elk_repofile_result.stat.exists

# apt_key and get_url fails if using proxies as ansible only works with http proxies
# so copy the key file with curl and install it locally
# also command gives warning for "creates", so use "shell" module
  
- name: get ELK key
  shell: curl {{ elk_key_url }} -o GPG-KEY-elasticsearch
  args:
    warn: false
    creates: GPG-KEY-elasticsearch
  register: elk_key
# - debug: var=elk_key
- name: register ELK key
  apt_key: key=GPG-KEY-elasticsearch
  when: not elk_key.failed

- name: install apt transport for https
  apt:
    name: apt-transport-https
    update_cache: yes
